app-id: edu.berkeley.BOINC
runtime: org.gnome.Platform
runtime-version: '42'
sdk: org.gnome.Sdk
command: boincmgr
finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=pulseaudio
  - --share=network
  - --device=dri
  - --persist=.BOINC
  - --persist=.

modules:
  - shared-modules/glu/glu-9.json

  - name: wxWidgets
    buildsystem: cmake-ninja
    sources:
      - type: git
        url: https://github.com/wxWidgets/wxWidgets.git
        tag: v3.2.0
        commit: 5b5ec3804a31a3765d60ff351bbdf79eddb1e1f9
    cleanup:
      - /bin
      - /include
      - /share
      - /lib/wx/include

  ##### freeglut and libXmu needed for projects that display graphics
  ##### https://boinc.berkeley.edu/trac/wiki/GraphicsApi#api
  - name: freeglut
    buildsystem: cmake-ninja
    build-options:
      cflags: -fcommon
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/freeglut/freeglut-3.2.1.tar.gz
        sha256: d4000e02102acaf259998c870e25214739d1f16f67f99cb35e4f46841399da68
    cleanup:
      - /include

  - name: libXmu
    sources:
      - type: archive
        url: https://www.x.org/releases/individual/lib/libXmu-1.1.3.tar.gz
        sha256: 5bd9d4ed1ceaac9ea023d86bf1c1632cd3b172dce4a193a72a94e1d9df87a62e
    cleanup:
      - /include
      - /share
  #####

  - name: boinc
    buildsystem: autotools
    config-opts:
      - --enable-shared
      - --disable-server
      - --disable-fcgi
      - --enable-unicode
    make-install-args:
      - DESTDIR=${FLATPAK_DEST}
      - prefix=
      - exec_prefix=
    sources:
      - type: git
        url: https://github.com/BOINC/boinc.git
        tag: client_release/7.20/7.20.2
        commit: 82d0a3731c743884b6e7a25d68c6558eca691635
      - type: file
        path: edu.berkeley.BOINC.metainfo.xml
      ### Patch to change 2 prefs - workaround the broken simple GUI and exit the boinc client when boincmgr closes
      - type: patch
        path: change-application-defaults.patch
      ### Patch to check for skins under /app
      - type: patch
        path: skin-location.patch
      - type: shell
        commands:
          - ./_autosetup
    post-install:
      ### Overwrite BOINCDIR or else it will warn that it can't find gui_rpc_auth.cfg
      - sed -i 's:#BOINCDIR=/var/lib/boinc:BOINCDIR=/:' ${FLATPAK_DEST}/etc/boinc-client.conf
      - install -Dm644 clientgui/res/boinc.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg
      - install -Dm644 clientgui/res/boinc.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - install -Dm644 edu.berkeley.BOINC.metainfo.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml
      - desktop-file-edit --remove-key=Path ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - desktop-file-edit --set-icon=${FLATPAK_ID} ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
    cleanup:
      - /usr
